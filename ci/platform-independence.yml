# Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

steps:
  - bash: ci/dev-env-install.sh
    displayName: 'Build/Install the Developer Environment'
  - bash: ci/configure-bazel.sh
    displayName: 'Configure Bazel for root workspace'
    env:
      IS_FORK: $(System.PullRequest.IsFork)
      # to upload to the bazel cache
      GOOGLE_APPLICATION_CREDENTIALS_CONTENT: $(GOOGLE_APPLICATION_CREDENTIALS_CONTENT)
  - task: DownloadPipelineArtifact@0
    inputs:
      artifactName: 'platform-independence-dar'
      targetPath: $(Build.StagingDirectory)/
  - bash: |
      set -euo pipefail
      eval "$(dev-env/bin/dade-assist)"
      bazel build //compiler/damlc/tests:platform-independence.dar
      DIR1=$(mktemp -d)
      DIR2=$(mktemp -d)
      trap "rm -rf $DIR1; rm -rf $DIR2" EXIT

      unzip -d $DIR1 bazel-bin/compiler/damlc/tests/platform-independence.dar
      unzip -d $DIR2 $(Build.StagingDirectory)/platform-independence.dar
      # hie/hi files may differ.
      diff -r --strip-trailing-cr -x '*.hie' -x '*.hi' $DIR1 $DIR2
    displayName: 'Rebuild platform-independence.dar and compare contained Linux/Windows dalfs'
